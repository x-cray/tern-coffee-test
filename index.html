<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tern CoffeeScript test</title>
    <link rel="stylesheet" href="main.css"/>
</head>
<body>

<div id="editor">a = 1

hhhhhh.call 123

jjj = 679
</div>

<div id="viewer"></div>

<script src="./lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="./lib/cs/coffee-script.js" type="text/javascript" charset="utf-8"></script>
<script src="./lib/cs/coffee-reverse.js" type="text/javascript" charset="utf-8"></script>
<script>
    var Range = ace.require("./range").Range;
    var editor = ace.edit("editor");
    var editorSession = editor.getSession();
    var viewer = ace.edit("viewer");
    var deferredCall = ace.require("ace/lib/lang").deferredCall;
    var viewerSession = viewer.getSession();
    var sourceMap = null;
    var markerId = null;

    function getSourceLineMapping(line, column) {
        if (!sourceMap) {
            return null;
        }

        for (var i in sourceMap.generatedLines) {
            for (var j in sourceMap.generatedLines[i].columnMap) {
                var columnMap = sourceMap.generatedLines[i].columnMap[j];
                if (columnMap.sourceLine === line && columnMap.sourceColumn === column) {
                    return columnMap;
                }
            }
        }

        return null;
    }

    function updateCurrentToken(e) {
        viewerSession.removeMarker(markerId);
        var cursorPosition = editor.getCursorPosition();
        var mapping = getSourceLineMapping(cursorPosition.row, cursorPosition.column);

        if (mapping) {
//            console.log(mapping);
            viewer.moveCursorTo(mapping.generatedLine, mapping.generatedColumn);
//            markerId = viewerSession.addMarker(
//                new Range(
//                    mapping.generatedLine,
//                    mapping.generatedColumn,
//                    mapping.generatedLine,
//                    mapping.generatedColumn + 1
//                ),
//                "highlight",
//                "source-marker",
//                true
//            );
        }
    }

    var deferredupdateCurrentToken = deferredCall(updateCurrentToken);

    function onChangeCursor(e) {
        deferredupdateCurrentToken.schedule(200);
    }

    function recompileCoffee(e) {
        var source = editor.getValue();
        var result = null;

        try {
            var opts = {
                sourceMap: true,
                rewrite: true
            }
            var compilationResult = CoffeeScript.compile(source, opts);
            result = compilationResult.js
            sourceMap = compilationResult.sourceMap;
        }
        catch (ex) {
            result = "Compilation failed: " + ex;
        }

        result += "\n";
        for (var i in sourceMap.generatedLines) {
            for (var j in sourceMap.generatedLines[i].columnMap) {
                var columnMap = sourceMap.generatedLines[i].columnMap[j];
                result += "// " + columnMap.generatedLine + ", " + columnMap.generatedColumn + " -> " + columnMap.sourceColumn + ", " + columnMap.sourceLine + "\n";
            }
        }

        viewerSession.setValue(result, 0);
    }

    editor.setTheme("ace/theme/monokai");
    editor.on("changeSelection", onChangeCursor);
    editorSession.setMode("ace/mode/coffee");
    editorSession.on("change", recompileCoffee);
    viewer.setTheme("ace/theme/monokai");
    viewerSession.setMode("ace/mode/javascript");
    recompileCoffee(null);
</script>
</body>
</html>
